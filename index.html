 pixel.classList.add('pending');
            const colorName = deployedColors[selectedColorIndex].color;
            const originalColor = pixel.style.backgroundColor;
            pixel.style.backgroundColor = normalizeColorName(colorName);
            pixel.title = `Painting with ${colorName}...`;

            try {
                // Send the transaction and wait for it to be mined
                const tx = await contract.paint(x, y);
                showMessage(`Transaction sent: ${shortenAddress(tx.hash)}. Waiting for confirmation...`);
                await tx.wait();
                
                // The event listener will handle the final state update for everyone
                showMessage(`Transaction confirmed! Pixel (${x}, ${y}) is now ${colorName}.`);
            } catch (err) {
                console.error('Transaction failed:', err);
                showMessage(`Transaction failed: ${err.message}`);
                // Revert optimistic UI update on failure
                pixel.style.backgroundColor = originalColor;
            } finally {
                // Remove the pending state
                pixel.classList.remove('pending');
            }
        }

        // --- Event Listeners and Initial Setup ---
        window.onload = function() {
            buildGrid();
            buildColorPicker();

            connectBtn.addEventListener('click', connectWallet);
            disconnectBtn.addEventListener('click', disconnectWallet);
            openColorPickerBtn.addEventListener('click', openColorPickerModal);
            
            // Check for existing wallet connection on load
            if (window.ethereum) {
                window.ethereum.on('accountsChanged', (accounts) => {
                    if (accounts.length > 0) {
                        connectWallet();
                    } else {
                        disconnectWallet();
                    }
                });
            }
        };
    </script>
</body>
</html>
